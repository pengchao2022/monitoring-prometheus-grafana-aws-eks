name: Deploy Monitoring Stack with ALB

on:
  push:
    branches: [ main, master ]
    paths:
      - 'charts/**'
      - 'kubernetes/**'
      - '.github/workflows/deploy-monitoring.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production

env:
  CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  NAMESPACE: monitoring

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --region ${{ env.AWS_REGION }} \
          --name ${{ env.CLUSTER_NAME }}

    - name: Setup kubectl and Helm
      run: |
        # å®‰è£… kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        
        # å®‰è£… Helm
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3"
        chmod 700 get_helm.sh
        ./get_helm.sh

    - name: Pre-deployment cluster check
      run: |
        echo "ğŸ” Pre-deployment Cluster Diagnostics"
        echo "====================================="
        
        # æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
        echo "=== Node Status ==="
        kubectl get nodes -o wide
        
        # æ£€æŸ¥èŠ‚ç‚¹èµ„æº
        echo "=== Node Resources ==="
        kubectl describe nodes | grep -A 5 "Allocated resources" || echo "Resource info not available"
        
        # æ£€æŸ¥å­˜å‚¨ç±»
        echo "=== Storage Classes ==="
        kubectl get storageclass
        
        # æ£€æŸ¥ç°æœ‰å‘½åç©ºé—´
        echo "=== Existing Monitoring Namespace ==="
        kubectl get namespace ${{ env.NAMESPACE }} || echo "Namespace does not exist yet"

    - name: Verify AWS Load Balancer Controller
      run: |
        echo "ğŸ” Checking existing AWS Load Balancer Controller..."
        kubectl get pods -A | grep aws-load-balancer-controller || echo "âŒ AWS Load Balancer Controller not found"

    - name: Create monitoring namespace
      run: |
        kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

    - name: Create Grafana secret
      run: |
        kubectl create secret generic grafana-admin-secret \
          --namespace=${{ env.NAMESPACE }} \
          --from-literal=admin-user=${{ secrets.GRAFANA_ADMIN_USER }} \
          --from-literal=admin-password=${{ secrets.GRAFANA_ADMIN_PASSWORD }} \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Add Helm repositories
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update

    - name: Deploy kube-prometheus-stack with timeout
      id: helm-install
      run: |
        echo "ğŸš€ Starting kube-prometheus-stack installation..."
        echo "Start time: $(date)"
        
        # è®¾ç½®è¶…æ—¶å’Œé‡è¯•é€»è¾‘
        timeout 600s bash -c '
          for i in {1..3}; do
            echo "Attempt $i of 3..."
            if helm upgrade --install kube-prometheus-stack \
              prometheus-community/kube-prometheus-stack \
              --namespace ${{ env.NAMESPACE }} \
              --version 48.1.1 \
              --values charts/kube-prometheus-stack/values-alb.yaml \
              --wait \
              --timeout 15m \
              --atomic \
              --create-namespace; then
              echo "âœ… Helm installation successful on attempt $i"
              exit 0
            else
              echo "âŒ Helm installation failed on attempt $i"
              if [[ $i -lt 3 ]]; then
                echo "Waiting 30 seconds before retry..."
                sleep 30
              fi
            fi
          done
          echo "âŒ All installation attempts failed"
          exit 1
        '
        
        echo "Completion time: $(date)"

    - name: Real-time installation monitoring
      if: always()
      run: |
        echo "ğŸ“Š Real-time Installation Monitoring"
        echo "==================================="
        
        # æŒç»­ç›‘æ§ Pod çŠ¶æ€
        for i in {1..12}; do
          echo "--- Status check $i --- $(date)"
          echo "Pods:"
          kubectl get pods -n ${{ env.NAMESPACE }} --sort-by=.status.startTime | head -10
          
          echo "Events:"
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by=.lastTimestamp --field-selector type=Warning 2>/dev/null | tail -5 || echo "No warning events"
          
          # æ£€æŸ¥é•œåƒæ‹‰å–çŠ¶æ€
          echo "Image Pull Status:"
          kubectl get pods -n ${{ env.NAMESPACE }} -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.phase}{"\t"}{range .status.containerStatuses[*]}{.state.waiting.reason}{" "}{.state.waiting.message}{"\t"}{end}{"\n"}{end}' 2>/dev/null || echo "Cannot get detailed status"
          
          if [[ $i -lt 12 ]]; then
            sleep 10
          fi
        done

    - name: Post-installation diagnostics
      if: always()
      run: |
        echo "ğŸ” Post-installation Diagnostics"
        echo "================================"
        
        # æ£€æŸ¥ Helm release çŠ¶æ€
        echo "=== Helm Release Status ==="
        helm list -n ${{ env.NAMESPACE }} || echo "Helm release not found"
        
        # è¯¦ç»† Pod è¯Šæ–­
        echo "=== Detailed Pod Diagnostics ==="
        kubectl get pods -n ${{ env.NAMESPACE }} -o wide
        
        # æ£€æŸ¥ Pod è¯¦ç»†çŠ¶æ€
        for pod in $(kubectl get pods -n ${{ env.NAMESPACE }} --no-headers -o custom-columns=":metadata.name"); do
          echo "--- Diagnosing pod: $pod ---"
          kubectl describe pod $pod -n ${{ env.NAMESPACE }} | grep -A 10 "Events:" || echo "No events found"
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          kubectl get pod $pod -n ${{ env.NAMESPACE }} -o jsonpath='{range .status.containerStatuses[*]}{.name}{": "}{.state}{"\n"}{end}' 2>/dev/null || echo "Cannot get container status"
        done
        
        # æ£€æŸ¥ PVC çŠ¶æ€
        echo "=== PVC Status ==="
        kubectl get pvc -n ${{ env.NAMESPACE }} -o wide
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        echo "=== Service Status ==="
        kubectl get services -n ${{ env.NAMESPACE }}
        
        # æ£€æŸ¥æœ€è¿‘çš„äº‹ä»¶
        echo "=== Recent Events (last 20) ==="
        kubectl get events -n ${{ env.NAMESPACE }} --sort-by=.lastTimestamp | tail -20

    - name: Deploy Ingress resources
      if: steps.helm-install.outcome == 'success'
      run: |
        kubectl apply -f kubernetes/ingress/ -n ${{ env.NAMESPACE }}

    - name: Wait for ALB provisioning
      if: steps.helm-install.outcome == 'success'
      run: |
        echo "â³ Waiting for ALB provisioning..."
        
        # ç­‰å¾… ALB åˆ›å»ºï¼Œå¸¦è¶…æ—¶
        timeout 300s bash -c '
          while true; do
            ALB_HOSTNAME=$(kubectl get ingress grafana-ingress -n ${{ env.NAMESPACE }} -o jsonpath="{.status.loadBalancer.ingress[0].hostname}" 2>/dev/null)
            if [[ -n "$ALB_HOSTNAME" ]]; then
              echo "âœ… ALB provisioned: $ALB_HOSTNAME"
              break
            fi
            echo "Waiting for ALB... (current time: $(date))"
            sleep 30
          done
        '
        
        echo "ALB Status:"
        kubectl get ingress -n ${{ env.NAMESPACE }}

    - name: Final health check
      if: steps.helm-install.outcome == 'success'
      run: |
        chmod +x scripts/health-check.sh
        ./scripts/health-check.sh

    - name: Get ALB endpoints
      if: steps.helm-install.outcome == 'success'
      id: endpoints
      run: |
        GRAFANA_ALB=$(kubectl get ingress grafana-ingress -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")
        PROMETHEUS_ALB=$(kubectl get ingress prometheus-ingress -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")
        ALERTMANAGER_ALB=$(kubectl get ingress alertmanager-ingress -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")
        
        echo "grafana_alb=$GRAFANA_ALB" >> $GITHUB_OUTPUT
        echo "prometheus_alb=$PROMETHEUS_ALB" >> $GITHUB_OUTPUT
        echo "alertmanager_alb=$ALERTMANAGER_ALB" >> $GITHUB_OUTPUT
        
        echo "Grafana ALB: $GRAFANA_ALB"
        echo "Prometheus ALB: $PROMETHEUS_ALB"
        echo "Alertmanager ALB: $ALERTMANAGER_ALB"

    - name: Create deployment summary
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const helmStatus = '${{ steps.helm-install.outcome }}';
          const grafanaAlb = '${{ steps.endpoints.outputs.grafana_alb }}';
          const prometheusAlb = '${{ steps.endpoints.outputs.prometheus_alb }}';
          const alertmanagerAlb = '${{ steps.endpoints.outputs.alertmanager_alb }}';
          
          let statusMessage = '';
          let details = '';
          
          if (helmStatus === 'success') {
            statusMessage = 'ğŸ‰ Monitoring Stack with ALB éƒ¨ç½²å®Œæˆ!';
            details = `**ALB è®¿é—®åœ°å€:**\n- ğŸ“Š Grafana: http://${grafanaAlb}\n- ğŸ“ˆ Prometheus: http://${prometheusAlb}\n- ğŸš¨ Alertmanager: http://${alertmanagerAlb}\n\n**ç™»å½•ä¿¡æ¯:**\n- Grafana ç”¨æˆ·å: \`${{ secrets.GRAFANA_ADMIN_USER }}\`\n- Grafana å¯†ç : \`${{ secrets.GRAFANA_ADMIN_PASSWORD }}\``;
          } else {
            statusMessage = 'âŒ Monitoring Stack éƒ¨ç½²å¤±è´¥';
            details = 'Helm å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°è¶…æ—¶æˆ–é”™è¯¯ã€‚è¯·æ£€æŸ¥è¯Šæ–­æ—¥å¿—äº†è§£å…·ä½“åŸå› ã€‚';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${statusMessage}\n\n${details}\n\n**è¯Šæ–­ä¿¡æ¯:**\n- Helm å®‰è£…ç»“æœ: ${helmStatus}\n- éƒ¨ç½²æ—¶é—´: çº¦ 15 åˆ†é’Ÿï¼ˆåŒ…å«è¯Šæ–­ï¼‰`
          });