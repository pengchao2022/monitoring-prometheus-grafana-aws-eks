name: Destroy Monitoring Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production
      confirm_destroy:
        description: 'ç¡®è®¤åˆ é™¤ (è¾“å…¥ "DESTROY" ç¡®è®¤)'
        required: true
        type: string

env:
  CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  NAMESPACE: monitoring

jobs:
  destroy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    # åªæœ‰åœ¨ç¡®è®¤è¾“å…¥æ­£ç¡®æ—¶æ‰è¿è¡Œ
    if: ${{ github.event.inputs.confirm_destroy == 'DESTROY' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --region ${{ env.AWS_REGION }} \
          --name ${{ env.CLUSTER_NAME }}

    - name: Setup Helm
      uses: azure/setup-helm@v3

    - name: Uninstall Helm releases
      run: |
        echo "ğŸ—‘ï¸ Uninstalling Helm releases..."
        helm uninstall kube-prometheus-stack -n ${{ env.NAMESPACE }} --ignore-not-found=true

    - name: Delete Ingress resources
      run: |
        echo "ğŸ—‘ï¸ Deleting Ingress resources (this will delete ALB)..."
        kubectl delete -f kubernetes/ingress/ -n ${{ env.NAMESPACE }} --ignore-not-found=true

    - name: Wait for resource cleanup
      run: |
        echo "â³ Waiting for resource cleanup..."
        sleep 60

    - name: Cleanup PVCs and secrets
      run: |
        echo "ğŸ—‘ï¸ Cleaning up Persistent Volume Claims..."
        kubectl delete pvc -n ${{ env.NAMESPACE }} --all --ignore-not-found=true
        
        echo "ğŸ—‘ï¸ Cleaning up secrets..."
        kubectl delete secret grafana-admin-secret -n ${{ env.NAMESPACE }} --ignore-not-found=true

    - name: Delete namespace
      run: |
        echo "ğŸ—‘ï¸ Deleting namespace..."
        kubectl delete namespace ${{ env.NAMESPACE }} --ignore-not-found=true

    - name: Confirm deletion
      run: |
        echo "âœ… Cleanup completed!"
        echo "Checking remaining resources:"
        kubectl get namespaces | grep ${{ env.NAMESPACE }} || echo "Namespace ${{ env.NAMESPACE }} deleted"
        helm list -n ${{ env.NAMESPACE }} | grep kube-prometheus-stack || echo "Helm release deleted"

    - name: Create cleanup summary
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ§¹ Monitoring Stack æ¸…ç†å®Œæˆ!\n\næ‰€æœ‰èµ„æºå·²ä»é›†ç¾¤ä¸­åˆ é™¤:\n- Helm releases\n- Ingress resources (ALB)\n- Persistent Volume Claims\n- Secrets\n- Namespace\n\nå¦‚éœ€é‡æ–°éƒ¨ç½²ï¼Œè¯·å†æ¬¡è¿è¡Œéƒ¨ç½²å·¥ä½œæµã€‚`
          });

  pre-destroy-check:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    # æ£€æŸ¥ç¡®è®¤è¾“å…¥
    if: ${{ github.event.inputs.confirm_destroy != 'DESTROY' }}
    
    steps:
    - name: Check destruction confirmation
      run: |
        echo "âŒ é”€æ¯æ“ä½œæœªç¡®è®¤!"
        echo "è¯·åœ¨ç¡®è®¤è¾“å…¥æ¡†ä¸­è¾“å…¥ 'DESTROY' æ¥ç¡®è®¤åˆ é™¤æ“ä½œ"
        exit 1